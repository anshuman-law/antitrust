<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Competition Law Lab | Law Matters Online Academy</title>
  <style>
    :root{
      --bg:#070b18; --panel:#0e1630; --ink:#eaf1ff; --muted:#9fb0cc;
      --p1:#7cc0ff; --p2:#8ef1e8; --p3:#b98bff; --p4:#ffd580;
      --br:18px; --glass:rgba(255,255,255,.04); --stroke:rgba(124,192,255,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 15% -10%,#121a3a 0%,var(--bg) 60%);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body::before{content:"";position:fixed;inset:0;pointer-events:none;background:
      radial-gradient(2px 2px at 18% 30%, rgba(255,255,255,.08) 0, transparent 60%),
      radial-gradient(2px 2px at 72% 58%, rgba(255,255,255,.06) 0, transparent 60%),
      radial-gradient(2px 2px at 40% 82%, rgba(255,255,255,.04) 0, transparent 60%);}    
    header{padding:22px 16px 8px;max-width:1200px;margin:0 auto}
    h1{font-size:clamp(24px,4vw,32px);margin:0 0 6px;font-weight:800;letter-spacing:.2px;background:linear-gradient(90deg,#cde5ff,#e7d6ff);-webkit-background-clip:text;background-clip:text;color:transparent}
    p.lead{margin:0 0 16px;color:var(--muted)}
    .wrap{max-width:1200px;margin:0 auto;padding:10px 16px 36px;display:grid;gap:16px}
    .row{display:grid;gap:16px}
    @media(min-width:1100px){.row{grid-template-columns:380px 1fr}}
    .card{position:relative;background:linear-gradient(180deg,var(--glass),rgba(255,255,255,.02));border:1px solid var(--stroke);border-radius:var(--br);box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel{padding:16px}
    h2{font-size:16px;margin:2px 0 10px;color:#cfe1ff}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:#0f1b34;color:#d8e6ff;cursor:pointer;font-size:12px}
    .tab[aria-selected="true"]{background:linear-gradient(90deg,var(--p1),var(--p3));color:#0b1226;font-weight:800}
    .slider{display:grid;grid-template-columns:1fr 84px;gap:10px;align-items:center;margin:10px 0}
    label{font-size:13px;color:#dbe7ff}
    input[type=range]{-webkit-appearance:none;width:100%;height:8px;border-radius:999px;background:linear-gradient(90deg,var(--p1),var(--p2));outline:none;box-shadow:0 0 0 1px rgba(124,192,255,.2) inset, 0 6px 18px rgba(124,192,255,.15)}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:#0a122a;border:2px solid #bcdfff;box-shadow:0 0 0 3px rgba(124,192,255,.35)}
    .val{font-variant-numeric:tabular-nums;background:#0c1637;border:1px solid var(--stroke);border-radius:12px;padding:6px 8px;text-align:center;color:#cfe1ff;font-size:12px}
    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:1100px){.kpis{grid-template-columns:repeat(4,1fr)}}
    .kpi{padding:14px;border-radius:14px;background:linear-gradient(180deg,#0f1936,#0b1226);border:1px solid var(--stroke);transition:transform .12s ease, box-shadow .12s ease}
    .kpi:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(124,192,255,.15)}
    .kpi h4{margin:0 0 6px;font-size:12px;color:#aab9d6;display:flex;align-items:center;gap:6px}
    .kpi h4 i{width:8px;height:8px;border-radius:50%;display:inline-block;background:linear-gradient(90deg,var(--p1),var(--p3))}
    .big{font-size:24px;font-weight:800}
    .bar{height:10px;border-radius:999px;background:#12204a;overflow:hidden;border:1px solid var(--stroke)}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--p1),var(--p2),var(--p3))}
    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .footer{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px;padding:10px 14px;border-top:1px solid var(--stroke);border-radius:0 0 var(--br) var(--br)}
    details.sources{margin-top:10px}
    details.sources summary{cursor:pointer;color:#cfe1ff}
    .src{font-size:12px;line-height:1.45;color:#b8c6e6;padding-left:6px}
    .src b{color:#e2edff}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .pill{background:#0f1b34;border:1px solid var(--stroke);color:#cfe1ff;padding:8px 10px;border-radius:999px;text-align:center;font-size:12px;cursor:pointer}
    .pill:hover{filter:brightness(1.12)}
    .tag{display:inline-flex;gap:6px;align-items:center;padding:6px 8px;border:1px solid var(--stroke);border-radius:999px;background:#0f1b34;font-size:12px}
    .muted{color:#9fb0cc}
    .rowline{height:1px;background:linear-gradient(90deg,transparent,rgba(124,192,255,.3),transparent);margin:6px 0}
    .warn{color:#ffd580}

    /* Fix desktop overlap and sizing */
    .row{ grid-template-columns: 380px minmax(0,1fr) }           /* allow right col to shrink */
    .grid3{ grid-template-columns: repeat(3, minmax(0,1fr)) }    /* prevent intrinsic overflow */

    .card{ position: relative; z-index: 0; overflow: visible; }
    .card:focus-within{ z-index: 20; }                           /* bring active card above neighbor */
    .panel{ overflow: visible; }

    .tag select, .tag input{ width: 100%; max-width: 100%; }     /* controls fit their tag */
    .tag label{ display:block; }                                 /* GUPPI mini-fields stack cleanly */

    /* make dropdowns comfortable in narrow tag columns */
    .tag input[type=number]{ box-sizing: border-box; padding:4px 6px; }

    /* Ensure results card doesn’t overshadow inputs by default */
    #panel-dominance .card:nth-child(1),
    #panel-agreements .card:nth-child(1),
    #panel-merger .card:nth-child(1){ z-index: 1; }

  </style>
</head>
<body>
  <header>
    <h1>Competition Law Lab</h1>
    <p class="lead">Interactive modules for abuse of dominance, anticompetitive agreements, and merger control. Switch jurisdictions, adjust assumptions, and see how legal outcomes shift. Hover any control or metric to view the literature and provisions behind it.</p>
  </header>

  <main class="wrap">
    <div class="tabs" role="tablist">
      <button class="tab" role="tab" aria-selected="true" data-tab="dominance">Abuse of Dominance</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="agreements">Anticompetitive Agreements</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="merger">Merger Control</button>
    </div>

    <!-- DOMINANCE -->
    <section class="row" id="panel-dominance" role="tabpanel">
      <div class="card">
        <div class="panel">
          <h2>Market definition and structure</h2>
          <div class="grid2">
            <div class="slider" data-key="hmDelta" title="Hypothetical monopolist test. Use price or non-price change for zero-price or multi-sided services.">
              <label>HM test increment</label>
              <output class="val" id="hmDeltaVal">5</output>
              <input type="range" id="hmDelta" min="1" max="15" value="5" step="1"/>
            </div>
            <div class="slider" data-key="elasticity" title="Cross-price elasticity as a proxy for substitutability.">
              <label>Cross-price elasticity</label>
              <output class="val" id="elasticityVal">1.2</output>
              <input type="range" id="elasticity" min="0" max="3" value="1.2" step="0.1"/>
            </div>
            <div class="slider" data-key="barriers" title="Entry barriers: sunk costs, regulation, data control, network effects.">
              <label>Entry barriers</label>
              <output class="val" id="barriersVal">60</output>
              <input type="range" id="barriers" min="0" max="100" value="60" step="1"/>
            </div>
            <div class="slider" data-key="buyerPower" title="Countervailing buyer power can constrain market power.">
              <label>Buyer power</label>
              <output class="val" id="buyerPowerVal">30</output>
              <input type="range" id="buyerPower" min="0" max="100" value="30" step="1"/>
            </div>
          </div>

          <div class="rowline"></div>
          <div class="grid3">
            <div class="tag" title="Switch to non-price for zero-price or quality-focused markets.">
              HM mode
              <select id="hmMode">
                <option value="price">Price</option>
                <option value="nonprice">Non-price</option>
              </select>
            </div>
            <div class="tag">
              Jurisdiction
              <select id="domJur">
                <option value="eu">EU</option>
                <option value="india">India</option>
                <option value="us">US</option>
              </select>
            </div>
            <div class="tag">
              Firms
              <input id="firmCount" type="number" min="2" max="12" value="4" style="width:64px"/>
            </div>
          </div>

          <h2 style="margin-top:6px">Market shares</h2>
          <div id="sharesWrap" class="grid2"></div>

          <details class="sources" style="margin-top:10px">
            <summary>Sources used in this module</summary>
            <div class="src">
              <p><b>Market definition:</b> EU Market Definition Notice 2024 update on non-price/zero-price and multi-sided evidence. India: s. 2(r), 2(s), 19(7). US: DOJ–FTC substitutability.</p>
              <p><b>Dominance:</b> EU art. 102; Hoffmann-La Roche; AKZO threshold cues. India: s. 4 and s. 19(4) factors. US: §2 monopoly power requires high share and direct evidence.</p>
              <p class="muted">HHI/CR4 shown for structure only in dominance; legal finding depends on the jurisdictional tests.</p>
            </div>
          </details>
        </div>
        <div class="footer"><span class="mono" id="tip1">Hover any control for sources</span><span class="mono" id="sum1"></span></div>
      </div>

      <div class="card">
        <div class="panel">
          <h2>Results and conduct</h2>
          <div class="kpis">
            <div class="kpi" data-out="hhi" title="HHI is Σ s². Pedagogic structure screen."><h4><i></i>HHI</h4><div class="big" id="hhi">–</div><div class="bar"><i id="b_hhi" style="width:0%"></i></div></div>
            <div class="kpi" data-out="cr4" title="CR4 is the cumulative share of the top four firms."><h4><i></i>CR4</h4><div class="big" id="cr4">–</div><div class="bar"><i id="b_cr4" style="width:0%"></i></div></div>
            <div class="kpi" data-out="dominance" title="Composite dominance proxy from shares, HHI, barriers, buyer power, and jurisdictional cues."><h4><i></i>Dominance score</h4><div class="big" id="dom">–</div><div class="bar"><i id="b_dom" style="width:0%"></i></div></div>
            <div class="kpi" data-out="outcome" title="Indicative text reflecting EU 50 percent presumption, India s.19(4) factors, and US §2 standards."><h4><i></i>Indicative outcome</h4><div class="big" id="outcome">–</div></div>
          </div>

          <h2 style="margin-top:10px">Conduct selector</h2>
          <div class="grid3">
            <label title="US: below-cost + recoupment. EU: below-cost sufficient in many settings."><input type="checkbox" class="cond" value="predatory"/> Predatory pricing</label>
            <label title="EU: margin squeeze doctrine established; India/US context-specific."><input type="checkbox" class="cond" value="margin"/> Margin squeeze</label>
            <label title="Potential foreclosure; effects and efficiencies relevant."><input type="checkbox" class="cond" value="tying"/> Tying/bundling</label>
            <label title="Exclusive dealing and loyalty rebates; effects-based in EU post-Intel."><input type="checkbox" class="cond" value="exclusive"/> Exclusivity</label>
            <label title="EU Google Shopping litmus; self-preferencing concerns in platforms."><input type="checkbox" class="cond" value="selfpref"/> Self-preferencing</label>
            <label title="Refusal to supply/interoperability can be abusive in narrow conditions."><input type="checkbox" class="cond" value="refusal"/> Refusal to supply</label>
          </div>
        </div>
        <div class="footer"><span class="mono" id="tip1b">Hover a metric for sources</span><span class="mono" id="sum1b"></span></div>
      </div>
    </section>

    <!-- AGREEMENTS -->
    <section class="row" id="panel-agreements" role="tabpanel" hidden>
      <div class="card">
        <div class="panel">
          <h2>Inputs</h2>
          <div class="grid2">
            <div class="slider" data-key2="horizShare" title="Combined market share of participants in a horizontal agreement.">
              <label>Combined share (horizontal)</label>
              <output class="val" id="horizShareVal">60</output>
              <input type="range" id="horizShare" min="0" max="100" value="60" step="1"/>
            </div>
            <div class="slider" data-key2="evidence" title="Direct plus circumstantial evidence of agreement or concerted practice.">
              <label>Evidence strength</label>
              <output class="val" id="evidenceVal">70</output>
              <input type="range" id="evidence" min="0" max="100" value="70" step="1"/>
            </div>
            <div class="slider" data-key2="transparency" title="Market transparency facilitating coordination.">
              <label>Market transparency</label>
              <output class="val" id="transparencyVal">50</output>
              <input type="range" id="transparency" min="0" max="100" value="50" step="1"/>
            </div>
            <div class="slider" data-key2="verticalShare" title="Supplier or buyer share for vertical restraints; EU safe harbour ≤ 30 if no hardcore.">
              <label>Party share (vertical)</label>
              <output class="val" id="verticalShareVal">25</output>
              <input type="range" id="verticalShare" min="0" max="100" value="25" step="1"/>
            </div>
          </div>

          <div class="rowline"></div>
          <div class="grid3">
            <div class="tag">Jurisdiction
              <select id="agrJur">
                <option value="eu">EU</option>
                <option value="india">India</option>
                <option value="us">US</option>
              </select>
            </div>
            <div class="tag">Horizontal type
              <select id="horizType" title="Horizontal restrictions: EU object, US per se, India s.3(3) presumption.">
                <option>Price fixing</option>
                <option>Market allocation</option>
                <option>Bid rigging</option>
                <option>Output restriction</option>
              </select>
            </div>
            <div class="tag">Vertical type
              <select id="vertType" title="VBER safe harbour when each share ≤ 30 and no hardcore; RPM is hardcore in EU.">
                <option>Resale price maintenance</option>
                <option>Exclusive distribution</option>
                <option>Selective distribution</option>
                <option>Tying</option>
              </select>
            </div>
          </div>

          <details class="sources" style="margin-top:10px">
            <summary>Sources used in this module</summary>
            <div class="src">
              <p><b>Horizontal:</b> EU art. 101 object restrictions; US per se under §1; India s. 3(3) presumption.</p>
              <p><b>Vertical:</b> EU VBER 30 percent and hardcore list; India s. 3(4) effects-based; US RPM rule of reason (Leegin).</p>
            </div>
          </details>
        </div>
        <div class="footer"><span class="mono" id="tip2">Hover any control for sources</span><span class="mono" id="sum2"></span></div>
      </div>

      <div class="card">
        <div class="panel">
          <h2>Results</h2>
          <div class="kpis">
            <div class="kpi" data-out2="hardcore" title="Horizontal hardcore (EU object, US per se, India 3(3)); RPM hardcore in EU verticals."><h4><i></i>Hardcore risk</h4><div class="big" id="hardcore">–</div><div class="bar"><i id="b_hardcore" style="width:0%"></i></div></div>
            <div class="kpi" data-out2="effect" title="Effects proxy reflecting transparency, shares, and vertical foreclosure risk."><h4><i></i>Anticompetitive effects</h4><div class="big" id="ae">–</div><div class="bar"><i id="b_ae" style="width:0%"></i></div></div>
            <div class="kpi" data-out2="exemption" title="EU 101(3) exemption or efficiencies; VBER safe harbour boosts this if conditions met."><h4><i></i>Exemption likelihood</h4><div class="big" id="exempt">–</div><div class="bar"><i id="b_exempt" style="width:0%"></i></div></div>
            <div class="kpi" data-out2="agreOutcome" title="Indicative outcome based on the above."><h4><i></i>Indicative outcome</h4><div class="big" id="agreOutcome">–</div></div>
          </div>
        </div>
        <div class="footer"><span class="mono" id="tip2b">Hover a metric for sources</span><span class="mono" id="sum2b"></span></div>
      </div>
    </section>

    <!-- MERGER -->
    <section class="row" id="panel-merger" role="tabpanel" hidden>
      <div class="card">
        <div class="panel">
          <h2>Inputs</h2>
          <div class="grid2">
            <div class="slider" data-key3="preHHI" title="Approximate pre-merger HHI for the focal market.">
              <label>Pre-merger HHI</label>
              <output class="val" id="preHHIVal">1800</output>
              <input type="range" id="preHHI" min="0" max="10000" value="1800" step="50"/>
            </div>
            <div class="slider" data-key3="deltaHHI" title="Increase in HHI caused by the merger.">
              <label>ΔHHI</label>
              <output class="val" id="deltaHHIVal">250</output>
              <input type="range" id="deltaHHI" min="0" max="5000" value="250" step="10"/>
            </div>
            <div class="slider" data-key3="efficiencies" title="Cognizable, merger-specific, verifiable efficiencies.">
              <label>Efficiencies score</label>
              <output class="val" id="efficienciesVal">30</output>
              <input type="range" id="efficiencies" min="0" max="100" value="30" step="1"/>
            </div>
            <div class="slider" data-key3="entryMerger" title="Entry that is timely, likely, and sufficient.">
              <label>Entry likelihood</label>
              <output class="val" id="entryMergerVal">40</output>
              <input type="range" id="entryMerger" min="0" max="100" value="40" step="1"/>
            </div>
          </div>

          <div class="rowline"></div>
          <div class="grid3">
            <div class="tag">Merger type
              <select id="mergerType">
                <option>Horizontal</option>
                <option>Vertical</option>
                <option>Conglomerate</option>
              </select>
            </div>
            <!-- Jurisdiction selector -->
<div class="input-group">
  <label for="jurisdiction">Jurisdiction</label>
  <select id="jurisdiction">
    <option>US</option>
    <option>EU</option>
    <option>India</option>
    <option>General</option>
    <option>Other</option>
  </select>
</div>

<!-- New row for GUPPI -->
<div class="input-group guppi-row">
  <label>GUPPI parameters</label>
  <div class="guppi-block">
    <div>
      <label for="diversion">Diversion D<sub>AB</sub></label>
      <input type="number" id="diversion" step="0.1" value="0.2">
    </div>
    <div>
      <label for="margin">Margin B</label>
      <input type="number" id="margin" step="0.1" value="0.4">
    </div>
    <div>
      <label for="price">Price</label>
      <input type="number" id="price" step="0.1" value="1">
    </div>
  </div>
</div>


          </div>

          <details class="sources" style="margin-top:10px">
            <summary>Sources used in this module</summary>
            <div class="src">
              <p><b>US screens:</b> 2023 Merger Guidelines structural presumptions using HHI and ΔHHI.</p>
              <p><b>EU:</b> Horizontal Merger Guidelines indicative safe harbours for HHI and ΔHHI.</p>
              <p><b>India:</b> AAEC multifactor analysis; no formal HHI screens.</p>
              <p><b>Unilateral effects:</b> UPP/GUPPI with diversion and margins.</p>
            </div>
          </details>
        </div>
        <div class="footer"><span class="mono" id="tip3">Hover any control for sources</span><span class="mono" id="sum3"></span></div>
      </div>

      <div class="card">
        <div class="panel">
          <h2>Results</h2>
          <div class="kpis">
            <div class="kpi" data-out3="postHHI"><h4><i></i>Post-merger HHI</h4><div class="big" id="postHHI">–</div><div class="bar"><i id="b_postHHI" style="width:0%"></i></div></div>
            <div class="kpi" data-out3="screen" title="Screen reflects chosen jurisdiction thresholds."><h4><i></i>Screen flag</h4><div class="big" id="screen">–</div></div>
            <div class="kpi" data-out3="harm" title="Harm proxy blends structure, type, efficiencies, and entry."><h4><i></i>Harm risk</h4><div class="big" id="harm">–</div><div class="bar"><i id="b_harm" style="width:0%"></i></div></div>
            <div class="kpi" data-out3="guppi" title="GUPPI_A = p_B × margin_B × D_AB"><h4><i></i>GUPPI</h4><div class="big" id="guppi">–</div></div>
            <div class="kpi" data-out3="mergerOutcome"><h4><i></i>Indicative outcome</h4><div class="big" id="mergerOutcome">–</div></div>
          </div>
        </div>
        <div class="footer"><span class="mono" id="tip3b">Hover a metric for sources</span><span class="mono" id="sum3b"></span></div>
      </div>
    </section>
  </main>

  <script>
    // Tabs
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.setAttribute('aria-selected','false'));
      t.setAttribute('aria-selected','true');
      const id = t.dataset.tab;
      document.querySelectorAll('[role=tabpanel]').forEach(p=> p.hidden = true);
      document.getElementById('panel-'+id).hidden = false;
    }));

    // ===== DOMINANCE =====
    const Dom = {
      hmDelta: $('hmDelta'), hmDeltaVal: $('hmDeltaVal'),
      elasticity: $('elasticity'), elasticityVal: $('elasticityVal'),
      barriers: $('barriers'), barriersVal: $('barriersVal'),
      buyerPower: $('buyerPower'), buyerPowerVal: $('buyerPowerVal'),
      hmMode: $('hmMode'), domJur: $('domJur'),
      firmCount: $('firmCount'),
      sharesWrap: $('sharesWrap'),
      hhi: $('hhi'), b_hhi: $('b_hhi'), cr4: $('cr4'), b_cr4: $('b_cr4'),
      dom: $('dom'), b_dom: $('b_dom'), outcome: $('outcome'),
      conds: null, sumA: $('sum1'), sumB: $('sum1b')
    };
    function $(id){ return document.getElementById(id); }

    function buildShareControls(n=4){
      Dom.sharesWrap.innerHTML='';
      for(let i=1;i<=n;i++){
        const row = document.createElement('div'); row.className='slider';
        row.dataset.key = 's'+i;
        row.title = 'Firm '+i+' market share';
        row.innerHTML = `
          <label>Firm ${i} share</label>
          <output class="val" id="s${i}Val">${i===1?55: i===2?15: i===3?10:8}</output>
          <input type="range" id="s${i}" min="0" max="100" value="${i===1?55: i===2?15: i===3?10:8}" step="1"/>`;
        Dom.sharesWrap.appendChild(row);
      }
      Dom.conds = document.querySelectorAll('.cond');
      Dom.sharesWrap.querySelectorAll('input').forEach(el=> el.addEventListener('input', renderDominance));
    }

    function getShares(){
      const els = Dom.sharesWrap.querySelectorAll('input');
      const arr = [...els].map(e=> +e.value);
      const total = arr.reduce((a,b)=>a+b,0)||1;
      return total>100 ? arr.map(x=> x*100/total) : arr;
    }

    function renderDominance(){
      // sync vals
      ['hmDelta','elasticity','barriers','buyerPower'].forEach(k=> Dom[k+'Val'].textContent = Dom[k].value);
      Dom.sharesWrap.querySelectorAll('input').forEach(e=> $(e.id+'Val').textContent = e.value);

      const shares = getShares(); const s1 = shares[0]||0;
      const HHI = Math.round(shares.reduce((a,v)=>a+v*v,0));
      const CR4 = shares.slice(0,4).reduce((a,b)=>a+b,0);

      Dom.hhi.textContent = HHI; Dom.b_hhi.style.width = Math.min(100, HHI/100).toFixed(0)+'%';
      Dom.cr4.textContent = Math.round(CR4)+'%'; Dom.b_cr4.style.width = Math.min(100, CR4).toFixed(0)+'%';

      const barriers = +Dom.barriers.value/100;
      const buyer = +Dom.buyerPower.value/100;
      const sharePower = Math.min(1, (s1/100)*1.4 + (HHI/10000)*0.4);

      let baseDom = clamp01(0.5*sharePower + 0.35*barriers - 0.25*buyer);

      // EU 50% presumption cue
      if (Dom.domJur.value==='eu' && s1>=50) baseDom = Math.max(0.7, baseDom);

      Dom.dom.textContent = pct(baseDom);
      Dom.b_dom.style.width = (baseDom*100).toFixed(0)+'%';

      // Outcome
      let txt = 'Further analysis needed';
      if (Dom.domJur.value==='eu'){
        if (s1>=50) txt = 'Strong presumption of dominance';
        else if (baseDom>0.6) txt = 'Dominance likely';
      } else if (Dom.domJur.value==='india'){
        txt = baseDom>0.6 ? 'Dominance likely on s.19(4) factors' : 'Assess s.19(4) factors';
      } else {
        txt = baseDom>0.65 ? 'Monopoly power risk; seek direct evidence' : 'No monopoly power indication';
      }
      Dom.outcome.textContent = txt;

      Dom.sumA.textContent = `HHI=${HHI}  CR4=${Math.round(CR4)}%  Dom=${(baseDom*100|0)}% [${Dom.domJur.value.toUpperCase()} | ${Dom.hmMode.value}]`;
      Dom.sumB.textContent = Dom.sumA.textContent;
    }

    $('firmCount').addEventListener('input', e=>{ buildShareControls(Math.max(2,Math.min(12,+e.target.value||4))); renderDominance(); });
    ['hmDelta','elasticity','barriers','buyerPower','hmMode','domJur'].forEach(id=> $(id).addEventListener('input', renderDominance));

    // Conduct change -> just recompute dominance outcome text remains structure-based here
    document.querySelectorAll('.cond').forEach(c=> c.addEventListener('change', renderDominance));

    // ===== AGREEMENTS =====
    const Agr = {
      horizShare: $('horizShare'), horizShareVal: $('horizShareVal'),
      evidence: $('evidence'), evidenceVal: $('evidenceVal'),
      transparency: $('transparency'), transparencyVal: $('transparencyVal'),
      verticalShare: $('verticalShare'), verticalShareVal: $('verticalShareVal'),
      horizType: $('horizType'), vertType: $('vertType'),
      jur: $('agrJur'),
      hardcore: $('hardcore'), b_hardcore: $('b_hardcore'),
      ae: $('ae'), b_ae: $('b_ae'),
      exempt: $('exempt'), b_exempt: $('b_exempt'),
      outcome: $('agreOutcome'), sum: $('sum2'), sumb: $('sum2b')
    };

    function renderAgreements(){
      ['horizShare','evidence','transparency','verticalShare'].forEach(k=> Agr[k+'Val'].textContent = Agr[k].value);
      const hs = +Agr.horizShare.value/100;
      const ev = +Agr.evidence.value/100; const tr = +Agr.transparency.value/100; const vs = +Agr.verticalShare.value/100;

      const isHardHoriz = /Price|Market|Bid|Output/.test(Agr.horizType.value);
      const isRPM = Agr.vertType.value==='Resale price maintenance';

      // Hardcore risk by jurisdiction
      let hardcoreRisk = 0.0;
      if (Agr.jur.value==='eu'){
        hardcoreRisk = clamp01((isHardHoriz?0.85:0.20) + 0.25*hs + 0.25*ev + (isRPM?0.5:0));
      } else if (Agr.jur.value==='us'){
        hardcoreRisk = clamp01((isHardHoriz?0.85:0.15) + 0.25*hs + 0.25*ev); // RPM rule of reason -> no hardcore bump
      } else { // India
        hardcoreRisk = clamp01((isHardHoriz?0.8:0.2) + 0.25*hs + 0.25*ev);
      }
      Agr.hardcore.textContent = pct(hardcoreRisk); Agr.b_hardcore.style.width = (hardcoreRisk*100).toFixed(0)+'%';

      // Effects proxy
      const effect = clamp01(0.5*hardcoreRisk + 0.2*tr + 0.15*hs + 0.15*vs);
      Agr.ae.textContent = pct(effect); Agr.b_ae.style.width = (effect*100).toFixed(0)+'%';

      // Exemption likelihood
      let exemption = clamp01(0.7 - 0.6*effect);
      if (Agr.jur.value==='eu'){
        const vberSafe = (vs<=0.30 && !isRPM); // no hardcore and ≤30 percent
        if (vberSafe) exemption = Math.max(exemption, 0.8);
      }
      Agr.exempt.textContent = pct(exemption); Agr.b_exempt.style.width = (exemption*100).toFixed(0)+'%';

      // Outcome
      let txt = 'Further assessment needed';
      if (hardcoreRisk>0.75 && isHardHoriz) txt = Agr.jur.value==='us' ? 'Per se infringement risk' : 'Object/hardcore infringement risk';
      else if (isRPM && Agr.jur.value==='eu') txt = 'RPM hardcore risk (EU)';
      else if (effect>0.6) txt = 'Likely infringement unless exempted';
      else if (exemption>0.65) txt = 'Potentially exemptible/within safe harbour';
      Agr.outcome.textContent = txt;

      Agr.sum.textContent = `hardcore=${(hardcoreRisk*100|0)}%  effects=${(effect*100|0)}%  exemption=${(exemption*100|0)}%  [${Agr.jur.value.toUpperCase()}]`;
      Agr.sumb.textContent = Agr.sum.textContent;
    }

    document.querySelectorAll('#panel-agreements input, #panel-agreements select').forEach(el=> el.addEventListener('input', renderAgreements));

    // ===== MERGER =====
    const Mer = {
      preHHI:$('preHHI'), preHHIVal:$('preHHIVal'),
      deltaHHI:$('deltaHHI'), deltaHHIVal:$('deltaHHIVal'),
      efficiencies:$('efficiencies'), efficienciesVal:$('efficienciesVal'),
      entry:$('entryMerger'), entryVal:$('entryMergerVal'),
      mergerType:$('mergerType'), jur:$('jurMerger'),
      diversion:$('diversion'), marginB:$('marginB'), priceB:$('priceB'),
      postHHI:$('postHHI'), b_postHHI:$('b_postHHI'),
      screen:$('screen'), harm:$('harm'), b_harm:$('b_harm'),
      guppi:$('guppi'), outcome:$('mergerOutcome'),
      sum:$('sum3'), sumb:$('sum3b')
    };

    function renderMerger(){
      ['preHHI','deltaHHI','efficiencies','entry'].forEach(k=> Mer[k+'Val'].textContent = Mer[k].value);
      const pre=+Mer.preHHI.value, d=+Mer.deltaHHI.value, post=pre+d;
      Mer.postHHI.textContent = post; Mer.b_postHHI.style.width = Math.min(100, post/100).toFixed(0)+'%';

      // Jurisdictional screen
      let flag='No screen flag';
      if (Mer.jur.value==='us'){
        if (post>=1800 && d>=100) flag='Structural presumption (US 2023)';
        else if (post>=1000 && d>0) flag='Heightened scrutiny';
      } else if (Mer.jur.value==='eu'){
        if ((post>=1000 && post<2000 && d<250) || (post>=2000 && d<150)) flag='Unlikely concerns (EU HMG)';
        else flag='Further inquiry';
      } else {
        flag='No formal screen (India)';
      }
      Mer.screen.textContent = flag;

      // Harm proxy
      const eff=+Mer.efficiencies.value/100, entry=+Mer.entry.value/100;
      let harm = 0.5*(post/10000) + 0.3*(d/5000) - 0.2*eff - 0.2*entry;
      if (Mer.mergerType.value==='Vertical') harm += 0.15;
      if (Mer.mergerType.value==='Conglomerate') harm += 0.10;
      harm = clamp01(harm);
      Mer.harm.textContent = pct(harm); Mer.b_harm.style.width = (harm*100).toFixed(0)+'%';

      // GUPPI
      const DAB = clamp01(+Mer.diversion.value||0);
      const mB = clamp01(+Mer.marginB.value||0);
      const pB = Math.max(0, +Mer.priceB.value||0);
      const guppi = pB * mB * DAB; // simple form to display magnitude
      Mer.guppi.textContent = isFinite(guppi) ? (guppi*100).toFixed(0)+'%' : '–';

      // Outcome
      let txt = 'Unlikely to raise concerns';
      if (flag.includes('presumption') || harm>0.65 || (guppi>0.05 && Mer.mergerType.value==='Horizontal')) txt = 'Likely challenge/conditional approval';
      else if (flag.includes('Further') || harm>0.5 || guppi>0.03) txt = 'Possible remedies or second stage';
      Mer.outcome.textContent = txt;

      Mer.sum.textContent = `postHHI=${post}  ΔHHI=${d}  harm=${(harm*100|0)}%  GUPPI=${(guppi*100|0)}% [${Mer.jur.value.toUpperCase()}]`;
      Mer.sumb.textContent = Mer.sum.textContent;
    }
    document.querySelectorAll('#panel-merger input, #panel-merger select').forEach(el=> el.addEventListener('input', renderMerger));

    // ===== Utils =====
    const clamp01 = x=> Math.max(0,Math.min(1,x));
    const pct = x=> (x*100).toFixed(0)+'%';

    // Init
    buildShareControls(4);
    renderDominance();
    renderAgreements();
    renderMerger();
  </script>
</body>
</html>
